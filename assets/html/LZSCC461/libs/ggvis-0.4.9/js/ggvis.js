ggvis=function(t){function e(t){return decodeURI(window.location.search.replace(new RegExp("^(?:.*[&\\?]"+encodeURI(t).replace(/[\.\+\*]/g,"\\$&")+"(?:\\=([^&]*))?)?.*$","i"),"$1"))}function i(){return window.devicePixelRatio?window.devicePixelRatio:1}function r(){return"1"===e("viewer_pane")||"1"===e("__subapp__")}function n(){return"1"===e("viewer_export")}var s={plots:{},getPlot:function(t){return this.plots[t]||(this.plots[t]=new s.Plot(t)),this.plots[t]}};return s.CallbackRegistry=function(){function t(t){var e=t.indexOf(".");return e<0?t:t.substring(0,e)}var e=function(t){this._registry={},this._obj=t||null},i=e.prototype;return i.on=function(e,i){var r=t(e),n=this._registry;n[r]=n[r]||[],n[r].push({type:e,fn:i})},i.off=function(e){var i=t(e);if(i!==e){var r=this._registry[i];if(r)for(var n=r.length-1;n>=0;n--)r[n].type===e&&r.splice(n,1)}else delete this._registry[i]},i.trigger=function(t){var e=Array.prototype.slice.call(arguments,1),i=this._registry[t];if(i)for(var r=0;r<i.length;r++)i[r].fn.apply(this._obj,e)},e}(),s.Plot=function(){function e(t,e){return 0===$(t).not(e).length&&0===$(e).not(t).length}function a(t,e){if(null==e||void 0===t.properties)return{};var i=t.properties[e];if(null==i)return{};var r={};return i(r),r}var o=function(t){this.plotId=t,this.pendingData={},this.chart=null,this.spec=null,this.initialized=!1,this.opts={},this.brush=new o.Brush(this),this.handlers=[],this._callbacks=new s.CallbackRegistry(this)},h=o.prototype;return h.on=function(t,e){this._callbacks.on(t,e)},h.off=function(t){this._callbacks.off(t)},h.trigger=function(){this._callbacks.trigger.apply(this._callbacks,arguments)},h.parseSpec=function(t,e){var i=this;i.spec=t,i.opts=$.extend(!0,i.spec.ggvis_opts,e),vg.parse.spec(t,(function(t){var e=i.opts,s=!0;if(e.hover_duration&&0!==e.hover_duration&&(s=!1),i.initialized=!1,t=t({el:"#"+i.plotId,renderer:e.renderer||"svg",hover:s}),i.chart=t,i.setRenderer(e.renderer,!1),e.hover_duration&&0!==e.hover_duration&&(t.on("mouseover",(function(t,i){this.update({props:"hover",items:i,duration:e.hover_duration})})),t.on("mouseout",(function(t,i){this.update({props:"update",items:i,duration:e.hover_duration})}))),e.handlers&&$.each(e.handlers,(function(e,i){t.on(e,i)})),i.removeHandlers(),i.addHandlers(i.spec.handlers),i.brush.enable(),n()&&$(".plot-gear-icon").hide(),i.removeResizeListeners(),r())i.getWrapper().width("auto"),i.enableAutoResizeToWindow();else{var a=i.getWrapper();e.width&&a.width(e.width),e.height&&a.height(e.height),"auto"===e.width||"auto"===e.height?i.enableAutoResizeToWrapperParent():e.resizable&&i.enableResizable()}this.pendingData&&i.loadPendingData(),i.dataReady()&&i.initialUpdate()}))},h.getVegaDiv=function(){return $(this.chart._el)},h.getDiv=function(){return $("#"+this.plotId)},h.getWrapper=function(){return this.getDiv().parent()},h.getMarks=function(){return this.getVegaDiv().children("svg, canvas")},h.marksWidth=function(){var t=this.getMarks(),e=parseFloat(t[0].getAttribute("width"));return"canvas"===this.renderer&&(e/=i()),e},h.marksHeight=function(){var t=this.getMarks(),e=parseFloat(t[0].getAttribute("height"));return"canvas"===this.renderer&&(e/=i()),e},h.resizeEventNamespace=function(){return this.plotId+"_ggvis_resize"},h.removeResizeListeners=function(){this.disableResizable(),this.disableAutoResizeToWindow(),this.disableAutoResizeToWrapperParent()},h.resizeToWrapper=function(t,e){if(null!==this.chart){void 0===t&&(t=this.opts.duration),void 0===t&&(t=0),void 0===e&&(e=this.opts.keep_aspect),void 0===e&&(e=!1);var i=this.getWrapper(),r=i.find(".plot-gear-icon"),n=this.chart,s=n.padding(),a=this.opts.width/this.opts.height,o=i.width()-r.width()-s.left-s.right,h=i.height()-s.top-s.bottom;e&&(h>o/a?h=Math.floor(o/a):h<o/a&&(o=Math.floor(h*a))),h-=5,n.width(o),n.height(h),n.update({duration:t})}},h.resizeWrapperToWindow=function(){var t=$("body"),e=this.getWrapper(),i=t.outerHeight(!0)-t.height(),r=document.documentElement;e.height(r.clientHeight-i),e.height(2*(r.clientHeight-i)-t.height())},h.resizeWrapperToParent=function(){if("auto"===this.opts.height){var t=this.getWrapper();t.height(t.parent().height())}},h.initialUpdate=function(){this.initialized||this.chart.update({duration:0}),this.initialized=!0,r()?this.resizeWrapperToWindow():this.resizeWrapperToParent(),this.resizeToWrapper(0)},h.enableResizable=function(){var t=this;this.getWrapper().resizable({helper:"ui-resizable-helper",grid:[10,10],handles:"se",stop:function(){t.resizeToWrapper()}})},h.disableResizable=function(){var t=this.getWrapper();void 0!==t.resizable("instance")&&t.resizable("destroy")},h.enableAutoResizeToWindow=function(){var t=this,e=null;$(window).on("resize."+this.resizeEventNamespace(),(function(){clearTimeout(e),e=setTimeout((function(){t.resizeWrapperToWindow(),t.resizeToWrapper(0)}),100)}))},h.disableAutoResizeToWindow=function(){$(window).off("."+this.resizeEventNamespace())},h.enableAutoResizeToWrapperParent=function(){var t=this,e=null;this.getWrapper().parent().resize((function(){clearTimeout(e),e=setTimeout((function(){t.resizeWrapperToParent(),t.resizeToWrapper(0)}),100)}))},h.disableAutoResizeToWrapperParent=function(){try{this.getWrapper().parent().removeResize()}catch(t){}},h.onControlOutput=function(){r()&&(this.resizeWrapperToWindow(),this.resizeToWrapper(0))},h.loadPendingData=function(){this.chart.data(this.pendingData),delete this.pendingData},h.dataReady=function(){return e(Object.keys(this.chart.data()),this.spec.data.map((function(t){return t.name})))},h.setRenderer=function(t,e){t!==this.renderer&&(void 0===e&&(e=!0),this.renderer=t,e&&this.chart.renderer(t).update(),this.setRendererButton(t),this.updateDownloadButtonText(t))},h.setRendererButton=function(t){var e=$("#"+this.plotId+"_renderer_"+t);e.addClass("inactive"),e.siblings().removeClass("inactive")},h.updateDownloadLink=function(t){var e,i=$("#"+this.plotId+".ggvis-output .marks")[0];if("svg"===this.renderer){var r=$(i).clone().attr("xmlns","http://www.w3.org/2000/svg");r=$("<div>").append(r).html(),e="data:image/octet-stream;base64,\n"+btoa(r)}else"canvas"===this.renderer&&(e=i.toDataURL("image/png").replace("image/png","image/octet-stream"));var n="";"svg"===this.renderer?n=".svg":"canvas"===this.renderer&&(n=".png"),t.setAttribute("download",this.plotId+n),t.setAttribute("href",e)},h.updateDownloadButtonText=function(t){var e=$("#"+this.plotId+"_download");if(e[0]){var i="";"svg"===t?i="SVG":"canvas"===t&&(i="PNG"),e.text("Download "+i)}},h.removeHandlers=function(){for(var t=0;t<this.handlers.length;t++)this.handlers[t].remove();this.handlers=[]},h.addHandlers=function(t){if(t!==[]&&null!=t)for(var e,i,r=0;r<t.length;r++)e=t[r],i=s.handlers[e.type],this.handlers[r]=new i(this,e)},h._allMarkDefs=function(){return this.chart.model().defs().marks.marks},h._allMarks=function(){return this.chart.model().scene().items[0].items},h._getSceneBounds=function(){return this.chart.model().scene().items[0].bounds},o.Brush=function(){function e(t){if(void 0===t.offsetX){var e=$(t.currentTarget).offset();return{x:t.pageX-e.left,y:t.pageY-e.top}}return{x:t.offsetX,y:t.offsetY}}var i=function(t){this.plot=t,this._enabled=!1,this._brushBounds=new vg.Bounds,this._clickPoint=null,this._lastPoint=null,this._lastMatchingItems=[],this._callbacks=new s.CallbackRegistry(this),this._brushing=!1,this._dragging=!1},r=i.prototype;return r.on=function(t,e){this._callbacks.on(t,e)},r.off=function(t){this._callbacks.off(t)},r.trigger=function(){this._callbacks.trigger.apply(this._callbacks,arguments)},r.hasBrushMark=function(){return!!this._getBrushMarkDef()},r.enable=function(){if(this.hasBrushMark()){var i=this,r=this.plot.getDiv();i._enabled&&(r.off("mousedown.ggvis_brush"),r.off("mouseup.ggvis_brush"),r.off("mousemove.ggvis_brush"),i.off("brushMove"),i.off("updateItems")),r.on("mousedown.ggvis_brush","div.vega",(function(t){var r=i._removePadding(e(t));i._brushBounds.contains(r.x,r.y)?i._startDragging(r):i._startBrushing(r)})),r.on("mouseup.ggvis_brush","div.vega",(function(){i._dragging&&i._stopDragging(),i._brushing&&i._stopBrushing()})),r.on("mousemove.ggvis_brush","div.vega",(function(t){var r=i._removePadding(e(t));i._dragging&&i._dragTo(r),i._brushing&&i._brushTo(r)})),i.on("brushMove",i._updateBrush);var n=t.throttle(i._updateBrushedItems,50);i.on("brushMove",n),i._enabled=!0}},r._startDragging=function(t){this._dragging=!0,this._lastPoint=t,this._clickPoint=t,this.trigger("brushMove")},r._dragTo=function(t){if(this._dragging){var e=t.x-this._lastPoint.x,i=t.y-this._lastPoint.y;this._brushBounds.translate(e,i),this._lastPoint=t,this.trigger("brushMove")}},r._stopDragging=function(){this._dragging=!1,this._clickPoint=null,this.trigger("brushMove")},r._startBrushing=function(t){this._brushBounds.set(0,0,0,0),this._brushing=!0,this._clickPoint=t,this.trigger("brushMove")},r._brushTo=function(t){if(this._brushing){var e=this.plot._getSceneBounds(),i=t,r=Math.min(Math.max(this._clickPoint.x,i.x),e.x2),n=Math.max(Math.min(this._clickPoint.x,i.x),e.x1),s=Math.min(Math.max(this._clickPoint.y,i.y),e.y2),a=Math.max(Math.min(this._clickPoint.y,i.y),e.y1);this._brushBounds.set(n,a,r,s),this.trigger("brushMove")}},r._stopBrushing=function(){this._brushing=!1,this._clickPoint=null,this.trigger("brushMove")},r._updateBrush=function(){this.plot.chart.data({ggvis_brush:[{x:this._brushBounds.x1,y:this._brushBounds.y1,width:this._brushBounds.width(),height:this._brushBounds.height()}]}),this.plot.chart.update({props:"update",items:this._getBrushItem()})},r._updateBrushedItems=function(){for(var e=this._getBrushableItems(),i=[],r=0;r<e.length;r++)this._brushBounds.intersects(e[r].bounds)&&i.push(e[r]);var n=t.difference(i,this._lastMatchingItems),s=t.difference(this._lastMatchingItems,i);this._lastMatchingItems=i,this.plot.chart.update({props:"brush",items:n}),this.plot.chart.update({props:"update",items:s});var a=this._brushBounds,o={plot_id:this.plot.plotId,x1:a.x1,x2:a.x2,y1:a.y1,y2:a.y2,items:i};this.trigger("updateItems",o)},r._getBrushMarkDef=function(){var e=t.find(this.plot._allMarkDefs(),(function(t){return"ggvis_brush"===(a(t,"ggvis").data||null)}));return void 0===e?null:e},r._getBrushMark=function(){var e=t.find(this.plot._allMarks(),(function(t){return"ggvis_brush"===(a(t.def,"ggvis").data||null)}));return void 0===e?null:e},r._getBrushItem=function(){var t=this._getBrushMark();return null===t||null===t.items?null:t.items[0]},r._getBrushableItems=function(){var e=this._getBrushMark(),i=this.plot._allMarks().filter((function(i){return!t.isEmpty(a(i.def,"brush"))&&i!==e})),r=t.pluck(i,"items");return t.flatten(r)},r._removePadding=function(t){return{x:t.x-this.plot.chart.padding().left,y:t.y-this.plot.chart.padding().top}},i}(),o}(),s.handlers={},s}(lodash),vg.data.treefacet=function(){function t(t){var r,n,s,a,o,h,u,l={key:"",keys:[],values:[]},d={},g=l.values;if(0===e.length)throw"Need at least one key";for(o=0,a=t.length;o<a;++o){for(h=0,n=[],s="";h<e.length;++h)u=i[h](t[o]),n.push(u),s+=(h>0?"|":"")+String(u);if(void 0===(r=d[s])){for(var c in r=d[s]={key:s,keys:n,index:g.length,data:{},values:[]},e)r.data[vg.field(e[c])[1]]=n[c];g.push(r)}r.values.push(t[o])}return l}var e=[],i=[];return t.keys=function(r){return e=r,i=vg.array(r).map(vg.accessor),t},t},$((function(){$("body").on("click",".ggvis-dropdown-toggle",(function(){$(this).next(".ggvis-dropdown").toggle()})),$("body").on("click",".ggvis-download",(function(){ggvis.plots[$(this).data("plot-id")].updateDownloadLink(this)})),$("body").on("click",".ggvis-renderer-button",(function(t){var e=$(this);ggvis.plots[e.data("plot-id")].setRenderer(e.data("renderer")),t.stopPropagation()}))}));